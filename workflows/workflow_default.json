{
  "fileName": "Inverlink___carga_conciliados.json",
  "fileContent": "{\n  \"createdAt\": \"2025-06-27T21:54:03.011Z\",\n  \"updatedAt\": \"2025-07-15T15:57:28.751Z\",\n  \"id\": \"bwp4fSY7Kisusg8w\",\n  \"name\": \"Inverlink - carga conciliados\",\n  \"active\": false,\n  \"isArchived\": false,\n  \"nodes\": [\n    {\n      \"parameters\": {},\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"typeVersion\": 1,\n      \"position\": [\n        -560,\n        -60\n      ],\n      \"id\": \"3cdae736-b3ea-415b-a180-50ca91de8b0c\",\n      \"name\": \"When clicking ‘Execute workflow’\"\n    },\n    {\n      \"parameters\": {\n        \"resource\": \"worksheet\",\n        \"operation\": \"readRows\",\n        \"workbook\": {\n          \"__rl\": true,\n          \"value\": \"01HZVEXTKXTRZDXXGT75AJFCFASOOWAHT2\",\n          \"mode\": \"list\",\n          \"cachedResultName\": \"Facturas\",\n          \"cachedResultUrl\": \"https://inverlink-my.sharepoint.com/personal/ekrypto_inverlink_com/_layouts/15/Doc.aspx?sourcedoc=%7B3B729C57-D3DC-40FF-9288-A0939D601E7A%7D&file=Facturas.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1\"\n        },\n        \"worksheet\": {\n          \"__rl\": true,\n          \"value\": \"{00000000-0001-0000-0000-000000000000}\",\n          \"mode\": \"list\",\n          \"cachedResultName\": \"Consolidado Facturas\",\n          \"cachedResultUrl\": \"https://inverlink-my.sharepoint.com/personal/ekrypto_inverlink_com/_layouts/15/Doc.aspx?sourcedoc=%7B3B729C57-D3DC-40FF-9288-A0939D601E7A%7D&file=Facturas.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1&activeCell=Consolidado%20Facturas!A1\"\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.microsoftExcel\",\n      \"typeVersion\": 2.1,\n      \"position\": [\n        -340,\n        -180\n      ],\n      \"id\": \"b52a8fc4-6fcd-451b-93ed-b48bae06c7e1\",\n      \"name\": \"excel facturas\",\n      \"credentials\": {\n        \"microsoftExcelOAuth2Api\": {\n          \"id\": \"UMjXt9SIb2Tb1XTc\",\n          \"name\": \"Excel Inverlink\"\n        }\n      }\n    },\n    {\n      \"parameters\": {},\n      \"type\": \"n8n-nodes-base.merge\",\n      \"typeVersion\": 3.2,\n      \"position\": [\n        0,\n        -40\n      ],\n      \"id\": \"fd4c3e5e-cce3-4ec0-98bc-2f7be28237b0\",\n      \"name\": \"Unión\"\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"const facturasOriginales = items.filter(i => i.json.hasOwnProperty(\\\"Monto total cobrado\\\"));\\nconst conciliados = items.filter(i => i.json.hasOwnProperty(\\\"Valor extracto\\\"));\\n\\n// Fecha para la validación\\nconst fecha_actual = new Date().toLocaleDateString('es-CO', { year: 'numeric', month: '2-digit', day: '2-digit' }); // Formato \\\"DD/MM/AAAA\\\"\\n\\n// 2. Crear un Set para búsqueda rápida (URL_factura|Valor)\\nconst setConciliados = new Set(\\n  conciliados.map(c => {\\n    // Usar las claves correctas para los objetos conciliados\\n    const url = c.json[\\\"Url factura\\\"]?.trim();\\n    const valor = parseFloat(c.json[\\\"Valor factura\\\"]);\\n    if (url && !isNaN(valor)) {\\n      return `${url}|${valor}`;\\n    }\\n    return null;\\n  }).filter(Boolean) // Eliminar nulos si los hubiera\\n);\\n\\n// 3. Recorrer las facturas originales y marcar como \\\"Conciliado OK\\\" si hay coincidencia\\nconst resultado = facturasOriginales.map(factura => {\\n  // Usar las claves correctas para los objetos de factura\\n  const url = factura.json[\\\"Url factura\\\"]?.trim();\\n  const valor = parseFloat(factura.json[\\\"Monto total cobrado\\\"]);\\n  \\n  // Construir la misma clave para la búsqueda\\n  const clave = `${url}|${valor}`;\\n\\n  // Verificar si la clave existe en el Set\\n  const estaConciliado = setConciliados.has(clave);\\n\\n  return {\\n    json: {\\n      ...factura.json,\\n      // Actualizar el estado basado en la conciliación\\n      \\\"Estado conciliado\\\": estaConciliado ? \\\"Conciliado OK\\\" : \\\"No conciliado\\\",\\n      \\\"Fecha conciliación\\\": estaConciliado ? fecha_actual : \\\"\\\",\\n      \\\"Valor conciliado\\\": estaConciliado ? valor : \\\"\\\"\\n    }\\n  };\\n});\\n\\n// Devuelve el array de objetos para que n8n pueda procesarlo\\nreturn resultado;\"\n      },\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [\n        180,\n        -40\n      ],\n      \"id\": \"af9cfdac-ee8a-4c1f-834a-889ed9caa38b\",\n      \"name\": \"Validación conciliados\"\n    },\n    {\n      \"parameters\": {\n        \"resource\": \"worksheet\",\n        \"operation\": \"upsert\",\n        \"workbook\": {\n          \"__rl\": true,\n          \"value\": \"01HZVEXTKXTRZDXXGT75AJFCFASOOWAHT2\",\n          \"mode\": \"list\",\n          \"cachedResultName\": \"Facturas\",\n          \"cachedResultUrl\": \"https://inverlink-my.sharepoint.com/personal/ekrypto_inverlink_com/_layouts/15/Doc.aspx?sourcedoc=%7B3B729C57-D3DC-40FF-9288-A0939D601E7A%7D&file=Facturas.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1\"\n        },\n        \"worksheet\": {\n          \"__rl\": true,\n          \"value\": \"{00000000-0001-0000-0000-000000000000}\",\n          \"mode\": \"list\",\n          \"cachedResultName\": \"Consolidado Facturas\",\n          \"cachedResultUrl\": \"https://inverlink-my.sharepoint.com/personal/ekrypto_inverlink_com/_layouts/15/Doc.aspx?sourcedoc=%7B3B729C57-D3DC-40FF-9288-A0939D601E7A%7D&file=Facturas.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1&activeCell=Consolidado%20Facturas!A1\"\n        },\n        \"dataMode\": \"autoMap\",\n        \"columnToMatchOn\": \"Id factura\",\n        \"options\": {\n          \"updateAll\": true\n        }\n      },\n      \"type\": \"n8n-nodes-base.microsoftExcel\",\n      \"typeVersion\": 2.1,\n      \"position\": [\n        380,\n        -40\n      ],\n      \"id\": \"0b6c9692-1145-4eb5-ab55-3873bffbae50\",\n      \"name\": \"Actualiza facturas\",\n      \"credentials\": {\n        \"microsoftExcelOAuth2Api\": {\n          \"id\": \"UMjXt9SIb2Tb1XTc\",\n          \"name\": \"Excel Inverlink\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"resource\": \"worksheet\",\n        \"operation\": \"readRows\",\n        \"workbook\": {\n          \"__rl\": true,\n          \"value\": \"01HZVEXTIWP4G5HEI7J5DYASYQ46DK7OQC\",\n          \"mode\": \"list\",\n          \"cachedResultName\": \"Extractos\",\n          \"cachedResultUrl\": \"https://inverlink-my.sharepoint.com/personal/ekrypto_inverlink_com/_layouts/15/Doc.aspx?sourcedoc=%7BD30D7F16-1F91-474F-804B-10E786AFBA02%7D&file=Extractos.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1\"\n        },\n        \"worksheet\": {\n          \"__rl\": true,\n          \"value\": \"{5E9DF66E-126B-40A3-9DE4-62E109BBB106}\",\n          \"mode\": \"list\",\n          \"cachedResultName\": \"Conciliados\",\n          \"cachedResultUrl\": \"https://inverlink-my.sharepoint.com/personal/ekrypto_inverlink_com/_layouts/15/Doc.aspx?sourcedoc=%7BD30D7F16-1F91-474F-804B-10E786AFBA02%7D&file=Extractos.xlsx&action=default&mobileredirect=true&DefaultItemOpen=1&activeCell=Conciliados!A1\"\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.microsoftExcel\",\n      \"typeVersion\": 2.1,\n      \"position\": [\n        -340,\n        -20\n      ],\n      \"id\": \"6ce9bffc-3142-4e61-9b39-48070d8b13d3\",\n      \"name\": \"extracto y factura consolidados\",\n      \"credentials\": {\n        \"microsoftExcelOAuth2Api\": {\n          \"id\": \"UMjXt9SIb2Tb1XTc\",\n          \"name\": \"Excel Inverlink\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"conditions\": {\n          \"options\": {\n            \"caseSensitive\": true,\n            \"leftValue\": \"\",\n            \"typeValidation\": \"strict\",\n            \"version\": 2\n          },\n          \"conditions\": [\n            {\n              \"id\": \"103d4b70-ec7a-4bf0-b322-75bee09cc9e5\",\n              \"leftValue\": \"={{ $json[\\\"Estado conciliado\\\"] }}\",\n              \"rightValue\": \"Conciliado OK\",\n              \"operator\": {\n                \"type\": \"string\",\n                \"operation\": \"equals\",\n                \"name\": \"filter.operator.equals\"\n              }\n            }\n          ],\n          \"combinator\": \"and\"\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 2.2,\n      \"position\": [\n        -160,\n        -180\n      ],\n      \"id\": \"a69f5493-8a4c-431c-b439-e5493e6f17e4\",\n      \"name\": \"validación estado conciliado\",\n      \"notes\": \"Se valida si la factura ya aparece como conciliada\"\n    }\n  ],\n  \"connections\": {\n    \"When clicking ‘Execute workflow’\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"excel facturas\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"extracto y factura consolidados\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"excel facturas\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"validación estado conciliado\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Unión\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Validación conciliados\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Validación conciliados\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Actualiza facturas\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"extracto y factura consolidados\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Unión\",\n            \"type\": \"main\",\n            \"index\": 1\n          }\n        ]\n      ]\n    },\n    \"validación estado conciliado\": {\n      \"main\": [\n        [],\n        [\n          {\n            \"node\": \"Unión\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"staticData\": null,\n  \"meta\": {\n    \"templateCredsSetupCompleted\": true\n  },\n  \"pinData\": {},\n  \"versionId\": \"874f6b3f-ddd5-44cf-90bd-6c7a35d5d667\",\n  \"triggerCount\": 0,\n  \"tags\": [\n    {\n      \"createdAt\": \"2025-06-03T20:36:49.469Z\",\n      \"updatedAt\": \"2025-06-03T20:36:49.469Z\",\n      \"id\": \"E9oSeWOtAViNQ19X\",\n      \"name\": \"Inverlink\"\n    }\n  ]\n}"
}